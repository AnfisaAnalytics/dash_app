<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Affiliate Analytics Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
:root {
    --bg-primary: #0f1419;
    --bg-secondary: #1a1f2e;
    --bg-tertiary: #242b3d;
    --text-primary: #e6eef6;
    --text-muted: #a0aec0;
    --border: #2d3748;
    --accent: #667eea;
    --positive: #48bb78;
    --negative: #f56565;
    --warning: #ecc94b;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    padding: 20px;
    line-height: 1.5;
}
.container { max-width: 1800px; margin: 0 auto; }
.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 2px solid var(--border);
}
h1 { font-size: 28px; font-weight: 600; }
.file-upload {
    background: var(--bg-secondary);
    padding: 12px 20px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
}
.file-upload:hover { background: var(--bg-tertiary); }
.file-upload input { display: none; }
.file-upload label {
    cursor: pointer;
    color: var(--accent);
    font-weight: 500;
}
.filters {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-bottom: 24px;
    padding: 16px;
    background: var(--bg-secondary);
    border-radius: 8px;
}
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
}
.filter-group label {
    font-size: 12px;
    color: var(--text-muted);
    font-weight: 500;
}
.filter-group select,
.filter-group input {
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    min-width: 160px;
}
.filter-group select:focus,
.filter-group input:focus {
    outline: none;
    border-color: var(--accent);
}
.btn-reset {
    background: var(--negative);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    align-self: flex-end;
    transition: opacity 0.2s;
}
.btn-reset:hover { opacity: 0.85; }
.metrics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.metric-card {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
}
.metric-label {
    font-size: 13px;
    color: var(--text-muted);
    margin-bottom: 8px;
    font-weight: 500;
}
.metric-value {
    font-size: 26px;
    font-weight: 700;
}
.metric-value.positive { color: var(--positive); }
.metric-value.negative { color: var(--negative); }
.summary-panel {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}
.panel {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
}
.panel strong {
    display: block;
    margin-bottom: 12px;
    color: var(--accent);
    font-size: 15px;
}
.small-note {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 8px;
    line-height: 1.4;
}
.compare-controls {
    display: flex;
    gap: 8px;
    margin-top: 10px;
}
.compare-controls select {
    flex: 1;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-primary);
    padding: 8px;
    border-radius: 6px;
    font-size: 13px;
}
.btn {
    background: var(--accent);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    font-size: 13px;
    transition: opacity 0.2s;
}
.btn:hover { opacity: 0.85; }
.btn.secondary {
    background: var(--bg-tertiary);
    color: var(--text-primary);
}
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
    gap: 20px;
    margin-bottom: 24px;
}
.chart-container {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
}
.chart-container h3 {
    color: var(--text-muted);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 12px;
}
.chart-wrapper {
    position: relative;
    height: 300px;
}
.table-container {
    background: var(--bg-secondary);
    padding: 20px;
    border-radius: 8px;
    border: 1px solid var(--border);
    margin-bottom: 24px;
}
.table-container h3 {
    color: var(--text-muted);
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 12px;
}
table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
}
thead {
    background: var(--bg-tertiary);
    position: sticky;
    top: 0;
    z-index: 10;
}
th {
    padding: 12px 10px;
    text-align: left;
    font-weight: 600;
    color: var(--text-muted);
    border-bottom: 2px solid var(--border);
    white-space: nowrap;
}
td {
    padding: 12px 10px;
    border-bottom: 1px solid var(--border);
}
tbody tr {
    cursor: pointer;
    transition: background 0.15s;
}
tbody tr:hover {
    background: var(--bg-tertiary);
}
tbody tr.highlight-row {
    background: rgba(102, 126, 234, 0.15);
}
.positive { color: var(--positive) !important; font-weight: 600; }
.negative { color: var(--negative) !important; font-weight: 600; }
.warning { color: var(--warning) !important; font-weight: 600; }
.status-badge {
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
}
.status-good {
    background: rgba(72, 187, 120, 0.15);
    color: var(--positive);
}
.status-bad {
    background: rgba(245, 101, 101, 0.15);
    color: var(--negative);
}
.details-expanded {
    background: var(--bg-tertiary);
    padding: 20px;
    border-radius: 8px;
    margin-top: 16px;
    border: 1px solid var(--border);
}
.no-data {
    text-align: center;
    padding: 60px 20px;
    color: var(--text-muted);
}
.problem-item {
    padding: 10px;
    margin: 6px 0;
    background: var(--bg-tertiary);
    border-radius: 6px;
    border-left: 3px solid var(--negative);
    font-size: 13px;
}
.problem-item.good {
    border-left-color: var(--positive);
}
.problem-item strong {
    color: var(--text-primary);
}
.split-detail {
    padding: 8px;
    margin: 4px 0;
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
    font-size: 12px;
}
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Affiliate Marketing Analytics</h1>
        <div class="file-upload">
            <label for="csvFile">Загрузить CSV</label>
            <input type="file" id="csvFile" accept=".csv">
        </div>
    </div>

    <div id="filters" class="filters" style="display:none;">
        <div class="filter-group">
            <label>Партнёр (Split 1)</label>
            <select id="partnerFilter" multiple size="4"></select>
        </div>
        <div class="filter-group">
            <label>Страна (Split 2)</label>
            <select id="countryFilter" multiple size="4"></select>
        </div>
        <div class="filter-group">
            <label>Дата от</label>
            <input type="date" id="dateFrom">
        </div>
        <div class="filter-group">
            <label>Дата до</label>
            <input type="date" id="dateTo">
        </div>
        <div class="filter-group">
            <label>Минимальный FTD</label>
            <input type="number" id="minFtd" placeholder="0">
        </div>
        <button class="btn-reset" onclick="resetFilters()">Сбросить</button>
    </div>

    <div id="content" class="content" style="display:none;">
        <div class="metrics-grid" id="metricsGrid"></div>

        <div id="fd2Breakdown" style="margin-top:10px;color:var(--text-muted);font-size:13px;"></div>

        <!-- новый блок: расширенный список партнёров с их FD→2Dep и разбором -->
        <div id="fd2Contributors" style="margin-top:6px;color:var(--text-muted);font-size:13px;"></div>

        <div class="summary-panel">
            <div class="panel" id="problemCohorts">
                <strong>Проблемные когорты (требуют внимания)</strong>
                <div id="problemList" style="margin-top:8px"></div>
            </div>

            <div class="panel" id="goodCohorts">
                <strong>Успешные когорты (перформящие)</strong>
                <div id="goodList" style="margin-top:8px"></div>
            </div>

            <div class="panel" id="comparePanel">
                <strong>Сравнение партнёров</strong>
                <div class="compare-controls">
                    <select id="compareA"></select>
                    <select id="compareB"></select>
                    <button class="btn" onclick="compareSelected()">Сравнить</button>
                </div>
                <div id="compareResult" class="small-note" style="margin-top:8px">Выберите 2 партнёра</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <h3>CNGR по партнёрам (Top 10 по CNGR 28D)</h3>
                <div class="chart-wrapper"><canvas id="cngrChart"></canvas></div>
            </div>

            <div class="chart-container">
                <h3>OAS Dynamics (последние 14 дат)</h3>
                <div class="chart-wrapper"><canvas id="oasChart"></canvas></div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container" style="width:100%;">
                <h3>Cost vs Profit 28D (по партнёру)</h3>
                <div class="chart-wrapper"><canvas id="profitChart"></canvas></div>
            </div>
        </div>

        <div class="table-container">
            <h3>Детальная статистика по источникам</h3>
            <div style="overflow:auto;max-height:500px;">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>Партнёр</th>
                            <th>Страна</th>
                            <th>Дата когорты</th>
                            <th>Cost</th>
                            <th>FTD</th>
                            <th>CPA</th>
                            <th>Avg Check</th>
                            <th>Dep Count</th>
                            <th>FD→2Dep %</th>
                            <th>Dep Summ</th>
                            <th>CNGR 28D</th>
                            <th>Profit 28D</th>
                            <th>OAS 28D</th>
                            <th>Crash FTD %</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody id="detailsTableBody"></tbody>
                </table>
            </div>
            <div id="rowDetails" class="details-expanded" style="display:none"></div>
        </div>
    </div>

    <div id="noData" class="no-data">
        <p style="color:var(--text-muted);font-size:15px">
            Загрузите CSV файл для начала анализа<br>
            <span style="font-size:13px;margin-top:8px;display:block">
                Требуются колонки: Split 1, Split 2, Cohort Date, First Deposit C, Marketing Spend, 
                1D/7D/14D/28D CNGR, 7D Deposit C, 7D Deposit S, First Deposit 2 Deposit Conversion, 
                Avg Check, Crash FTD и др.
            </span>
        </p>
    </div>
</div>

<script>
let rawData = [];
let charts = {};
let filters = { partner: [], country: [], dateFrom: null, dateTo: null, minFtd: 0 };
function parseNumber(v) {
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') return v || 0;
    let s = String(v).replace(/\s/g, '').replace(/\$/g, '').replace(/,/g, '');
    if (s === '') return 0;
    let n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}
function parsePercent(v) {
    if (v === null || v === undefined || v === '') return 0;
    if (typeof v === 'number') {
        return v <= 1 ? v * 100 : v;
    }
    let s = String(v).trim();
    if (s.endsWith('%')) s = s.slice(0, -1);
    s = s.replace(/,/g, '.').replace(/\s/g, '');
    let n = parseFloat(s);
    return isNaN(n) ? 0 : n;
}
function fetchCSV() {
    fetch('data.csv')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.text();
        })
        .then(data => {
            Papa.parse(data, {
                header: true,
                dynamicTyping: false,
                skipEmptyLines: true,
                complete: function (results) {
                    processCSVData(results.data);
                }
            });
        })
        .catch(() => {
            // Если загрузка файла не удалась, запрашиваем файл у пользователя
            document.getElementById('csvFile').addEventListener('change', handleFileSelect);
            alert('Файл data.csv не найден. Пожалуйста, загрузите CSV файл вручную.');
        });
}
function handleFileSelect(e) {
    const file = e.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: true,
        dynamicTyping: false,
        skipEmptyLines: true,
        complete: function (results) {
            processCSVData(results.data);
        }
    });
}
function processCSVData(data) {
    rawData = data.map(row => normalizeRow(row)).filter(row => row['Split 1'] && row['Split 2'] && row['Cohort Date']);
    
    if (rawData.length === 0) {
        alert('В файле нет строк с Split 1, Split 2 и Cohort Date');
        return;
    }
    initializeFilters();
    processData();
    document.getElementById('filters').style.display = 'flex';
    document.getElementById('content').style.display = 'block';
    document.getElementById('noData').style.display = 'none';
}
function normalizeRow(r) {
    const copy = {};
    for (let k in r) { copy[k.trim()] = r[k]; }
    copy['First Deposit C'] = parseNumber(copy['First Deposit C'] ?? copy['FTD'] ?? copy['FirstDepositC']);
    copy['Marketing Spend'] = parseNumber(copy['Marketing Spend'] ?? copy['Cost'] ?? copy['MarketingSpend']);
    copy['1D CNGR'] = parseNumber(copy['1D CNGR'] ?? copy['1D_Cngr']);
    copy['7D CNGR'] = parseNumber(copy['7D CNGR'] ?? copy['7D_Cngr']);
    copy['14D CNGR'] = parseNumber(copy['14D CNGR'] ?? copy['14D_Cngr']);
    copy['28D CNGR'] = parseNumber(copy['28D CNGR'] ?? copy['28D_Cngr']);
    copy['1D Deposit S'] = parseNumber(copy['1D Deposit S']);
    copy['7D Deposit S'] = parseNumber(copy['7D Deposit S']);
    copy['7D Deposit C'] = parseNumber(copy['7D Deposit C']);
    copy['First Deposit 2 Deposit Conversion'] = parsePercent(copy['First Deposit 2 Deposit Conversion'] ?? copy['FD_2_Dep_Conv']);
    copy['Avg Check'] = parseNumber(copy['Avg Check'] ?? copy['AvgCheck'] ?? copy['Average Check']);
    copy['Crash FTD'] = parsePercent(copy['Crash FTD'] ?? copy['CrashFTD'] ?? 0);
    copy['Cohort Date'] = normalizeDate(copy['Cohort Date']);
    copy['Split 1'] = (copy['Split 1'] || '').toString();
    copy['Split 2'] = (copy['Split 2'] || '').toString();
    return copy;
}
function normalizeDate(v) {
    if (!v) return null;
    if (/^\d{4}-\d{2}-\d{2}/.test(v)) return v.split('T')[0];
    const d = new Date(v);
    if (isNaN(d)) return v;
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}
function initializeFilters() {
    const partners = [...new Set(rawData.map(r => r['Split 1']))].sort();
    const countries = [...new Set(rawData.map(r => r['Split 2']))].sort();
    const psel = document.getElementById('partnerFilter');
    psel.innerHTML = '<option value="__all__">Все</option>' +
        partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    const csel = document.getElementById('countryFilter');
    csel.innerHTML = '<option value="__all__">Все</option>' +
        countries.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
    document.getElementById('partnerFilter').addEventListener('change', applyFilters);
    document.getElementById('countryFilter').addEventListener('change', applyFilters);
    document.getElementById('dateFrom').addEventListener('change', applyFilters);
    document.getElementById('dateTo').addEventListener('change', applyFilters);
    document.getElementById('minFtd').addEventListener('change', applyFilters);
    populateCompareSelects();
}
function getSelectedValues(selectEl) {
    if (!selectEl) return [];
    const selected = Array.from(selectEl.options).filter(o => o.selected).map(o => o.value);
    if (selected.includes('__all__')) return [];
    return selected;
}
function applyFilters() {
    filters.partner = getSelectedValues(document.getElementById('partnerFilter'));
    filters.country = getSelectedValues(document.getElementById('countryFilter'));
    filters.dateFrom = document.getElementById('dateFrom').value || null;
    filters.dateTo = document.getElementById('dateTo').value || null;
    filters.minFtd = parseInt(document.getElementById('minFtd').value || 0, 10);
    processData();
}
function processData() {
    const data = getFilteredData();
    // Ваша логика для обработки данных
}
function getFilteredData() {
    return rawData.filter(r => {
        if (filters.partner.length && !filters.partner.includes(r['Split 1'])) return false;
        if (filters.country.length && !filters.country.includes(r['Split 2'])) return false;
        if (filters.dateFrom && r['Cohort Date'] && new Date(r['Cohort Date']) < new Date(filters.dateFrom)) return false;
        if (filters.dateTo && r['Cohort Date'] && new Date(r['Cohort Date']) > new Date(filters.dateTo)) return false;
        if (filters.minFtd && (parseNumber(r['First Deposit C']) < filters.minFtd)) return false;
        return true;
    });
}
function populateCompareSelects() {
    const partners = [...new Set(rawData.map(r => r['Split 1']))].sort();
    const compareA = document.getElementById('compareA');
    const compareB = document.getElementById('compareB');
    if (!compareA || !compareB) return;
    compareA.innerHTML = '<option value="">—</option>' + partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
    compareB.innerHTML = '<option value="">—</option>' + partners.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
}
function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
// Вызываем загрузку CSV при старте страницы
fetchCSV();
    
</script>
</body>
</html>
